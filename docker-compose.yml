x-security: &security_hardening
  read_only: true
  cap_drop: ["ALL"]
  security_opt: ["no-new-privileges:true"]
  pids_limit: 256
  ulimits:
    nproc: 512
    nofile:
      soft: 4096
      hard: 8192

x-logging: &logging_rotated
  logging:
    driver: "json-file"
    options:
      max-size: "10m"
      max-file: "5"

networks:
  backend:

volumes:
  postgres_data:

secrets:
  postgres_password:
    file: ./secrets/postgres_password.txt

services:
  nginx:
    image: nginx:1.27-alpine
    <<: [ *security_hardening, *logging_rotated ]
    restart: unless-stopped
    depends_on:
      api-serve:
        condition: service_healthy
    networks: [ backend ]
    cpus: "0.50"
    mem_limit: "256m"
    volumes:
      - ./ops/nginx/nginx.conf:/etc/nginx/nginx.conf:ro
      - ./ops/nginx/conf.d/app.conf:/etc/nginx/conf.d/app.conf:ro
    tmpfs:
      - /var/run
      - /var/cache/nginx
    cap_add:
      - CHOWN
      - SETGID
      - SETUID

  api-base:
    build: .
    image: ${COMPOSE_PROJECT_NAME:-app}-base
    env_file: .env
    <<: [ *security_hardening, *logging_rotated ]
    restart: unless-stopped
    depends_on:
      db:
        condition: service_healthy
    networks: [ backend ]
    user: "1000:1000"
    tmpfs: [ /tmp ]
    cpus: "1.00"
    mem_limit: "768m"
    volumes:
      - ./media:/app/media:rw

  api-serve:
    extends:
      service: api-base
    command: >
      uvicorn app.main:app
      --host 0.0.0.0
      --port 8000
      --workers 2
    cpus: "1.50"
    mem_limit: "1g"
    healthcheck:
      test: ["CMD-SHELL", "wget -qO- http://127.0.0.1:8000/health || exit 1"]
      interval: 20s
      timeout: 3s
      retries: 5
      start_period: 20s

  cloudflared:
    image: cloudflare/cloudflared:2025.10.1
    <<: [ *security_hardening, *logging_rotated ]
    restart: unless-stopped
    networks: [ backend ]
    depends_on:
      nginx:
        condition: service_started
    cpus: "0.30"
    mem_limit: "128m"
    command: ["tunnel", "--no-autoupdate", "--url", "http://nginx:8080"]

  db:
    image: postgres:16-alpine
    <<: [ *logging_rotated ]
    restart: unless-stopped
    networks: [ backend ]
    cpus: "1.00"
    mem_limit: "768m"
    environment:
      POSTGRES_USER: app
      POSTGRES_DB: appdb
      POSTGRES_PASSWORD_FILE: /run/secrets/postgres_password
      PGDATA: /var/lib/postgresql/data
    secrets:
      - postgres_password
    volumes:
      - postgres_data:/var/lib/postgresql/data:rw
    healthcheck:
      test: ["CMD-SHELL", "pg_isready -U app -d appdb"]
      interval: 10s
      timeout: 3s
      retries: 5
      start_period: 15s
